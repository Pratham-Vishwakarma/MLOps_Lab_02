pipeline {
    agent any

    environment {
        AZURE_CREDENTIALS   = credentials('AZURE_CREDENTIALS')
        AZURE_RESOURCE_GROUP = credentials('AZURE_RESOURCE_GROUP')
        AZURE_WORKSPACE     = credentials('AZURE_WORKSPACE')
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Azure Login') {
            steps {
                powershell '''
                $creds = ConvertFrom-Json $env:AZURE_CREDENTIALS

                az login --service-principal `
                  --username $creds.clientId `
                  --password $creds.clientSecret `
                  --tenant $creds.tenantId

                az account set --subscription $creds.subscriptionId
                '''
            }
        }

        stage('Install Azure ML CLI Extension') {
            steps {
                powershell '''
                az extension add -n ml -y
                '''
            }
        }

        stage('Submit Azure ML Job') {
            steps {
                powershell '''
                az ml job create `
                  --file job.yml `
                  --resource-group $env:AZURE_RESOURCE_GROUP `
                  --workspace-name $env:AZURE_WORKSPACE
                '''
            }
        }

        stage('Check Job Status') {
            steps {
                powershell '''
                az ml job list `
                  --resource-group $env:AZURE_RESOURCE_GROUP `
                  --workspace-name $env:AZURE_WORKSPACE `
                  --output table
                '''
            }
        }

    }

    post {
        success {
            echo "Azure ML Job Submitted Successfully!"
        }
        failure {
            echo "Pipeline Failed!"
        }
    }
}